<#@ template debug="false" hostspecific="false" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ output extension=".cs" #>
using System;
using System.Threading.Tasks;
using Xunit;

namespace IX.Retry.UnitTests
{
<#
for (int t = 1; t <= 3; t++)
{
#>

	public class RetryTest_FuncTaskResult_Asynchronous_0_<#=t#>
	{
		int retries;
		int maxRetries;

        [Fact]
        public async Task Test()
        {
			maxRetries = 1;
			retries = 0;

			Random r = new Random();
			int param1 = r.Next();

            int result = await With.RetryAsync(DelegateMethod_FuncTaskResult_Asynchronous_0_<#=t#>, Policy.CountBasedRetryPolicy<InvalidOperationException>(1));

			Assert.True(retries == maxRetries);
			Assert.Equal(result, -32768);
        }

        private Task<int> DelegateMethod_FuncTaskResult_Asynchronous_0_<#=t#>()
        {
            if (retries < maxRetries)
            {
                retries++;
                throw new InvalidOperationException();
            }

			return Task.FromResult(-32768);
        }
	}
<#
	for (int i = 1; i <= 16; i++)
	{
		List<string> parameters = new List<string>();
		List<string> parameterNames = new List<string>();
		List<string> parameterValues = new List<string>();
		for (int j = 1; j <= i; j++)
		{
			parameters.Add(string.Format("int param{0}", j));
			parameterNames.Add(string.Format("param{0}", j));
			parameterValues.Add(string.Format("int param{0} = r.Next();", j));
		}
#>

	public class RetryTest_FuncTaskResult_Asynchronous_<#=i#>_<#=t#>
	{
		int retries;
		int maxRetries;

        [Fact]
        public async Task Test()
        {
			maxRetries = <#=t#>;
			retries = 0;

			Random r = new Random();
			<#= string.Join("\r\n            ", parameterValues) #>

            int result = await With.RetryAsync(DelegateMethod_FuncTaskResult_Asynchronous_<#=i#>_<#=t#>, Policy.CountBasedRetryPolicy<InvalidOperationException>(<#=t#>)<#=parameterNames.Count > 0 ? ", " : ""#><#= string.Join(", ", parameterNames) #>);
			int expectedResult = <#= string.Join(" + ", parameterNames) #>;

			Assert.True(retries == maxRetries);
			Assert.Equal(expectedResult, result);
        }

        private Task<int> DelegateMethod_FuncTaskResult_Asynchronous_<#=i#>_<#=t#>(<#= string.Join(", ", parameters) #>)
        {
            if (retries < maxRetries)
            {
                retries++;
                throw new InvalidOperationException();
            }

			return Task.FromResult(<#= string.Join(" + ", parameterNames) #>);
        }
	}
<#
	}
}
#>
}